(()=>{var g={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","\u2026":"&hellip;"};function w(o){return g[o]||o}function d(o){return o.replace(/[&<>"]/g,w)}function f(o){return o.replace(/[.*+\-?^${}()|[\]\\]/g,"\\$&")}var m=class o{data;form;input;list;resultTitle;resultTitleTemplate;constructor({form:t,input:e,list:n,resultTitle:s,resultTitleTemplate:r}){this.form=t,this.input=e,this.list=n,this.resultTitle=s,this.resultTitleTemplate=r,this.input.value.trim()!==""?this.doSearch(this.input.value.split(" ")):this.handleQueryString(),this.bindQueryStringChange(),this.bindSearchForm()}static processMatches(t,e,n=!0,s=140,r=20){e.sort((a,c)=>a.start-c.start);let h=0,i=0,l=0,u=[];for(;h<e.length;){let a=e[h];n&&a.start-r>i?(u.push(`${d(t.substring(i,i+r))} [...] `),u.push(`${d(t.substring(a.start-r,a.start))}`),l+=r*2):(u.push(d(t.substring(i,a.start))),l+=a.start-i);let c=h+1,p=a.end;for(;c<e.length&&e[c].start<=p;)p=Math.max(e[c].end,p),++c;if(u.push(`<mark>${d(t.substring(a.start,p))}</mark>`),l+=p-a.start,h=c,i=p,n&&l>s)break}if(i<t.length){let a=t.length;n&&(a=Math.min(a,i+r)),u.push(`${d(t.substring(i,a))}`),n&&a!=t.length&&u.push(" [...]")}return u.join("")}async searchKeywords(t){let e=await this.getData(),n=[],s=new RegExp(t.filter((r,h,i)=>(i[h]=f(r),r.trim()!=="")).join("|"),"gi");for(let r of e){let h=[],i=[],l={...r,preview:"",matchCount:0,matchKeywords:t.join(" "),matchPositions:[]},u=r.content.matchAll(s);for(let c of Array.from(u))i.push({start:c.index,end:c.index+c[0].length});let a=r.title.matchAll(s);for(let c of Array.from(a))h.push({start:c.index,end:c.index+c[0].length});l.matchPositions=[...h,...i],h.length>0&&(l.title=o.processMatches(l.title,h,!1)),i.length>0?l.preview=o.processMatches(l.content,i):l.preview=d(l.content.substring(0,140)),l.matchCount=h.length+i.length,l.matchCount>0&&n.push(l)}return n.sort((r,h)=>h.matchCount-r.matchCount)}async doSearch(t){let e=performance.now(),n=await this.searchKeywords(t);this.clear();for(let r of n)this.list.append(o.render(r));let s=performance.now();this.resultTitle.innerText=this.generateResultTitle(n.length,((s-e)/1e3).toPrecision(1)),setTimeout(()=>{window.pjax?window.pjax.refresh(document):window.$&&window.$.pjax&&window.$.pjax.refresh(document)},0)}generateResultTitle(t,e){return this.resultTitleTemplate.replace("#PAGES_COUNT",t).replace("#TIME_SECONDS",e)}async getData(){if(!this.data){let t=this.form.dataset.json;this.data=await fetch(t).then(n=>n.json());let e=new DOMParser;for(let n of this.data)n.content=e.parseFromString(n.content,"text/html").body.innerText}return this.data}bindSearchForm(){let t="",e=n=>{n.preventDefault();let s=this.input.value.trim();if(o.updateQueryString(s,!0),s==="")return t="",this.clear();t!==s&&(t=s,this.doSearch(s.split(" ")))};this.input.addEventListener("input",e),this.input.addEventListener("compositionend",e)}clear(){this.list.innerHTML="",this.resultTitle.innerText=""}bindQueryStringChange(){window.addEventListener("popstate",t=>{this.handleQueryString()})}handleQueryString(){let e=new URL(window.location.toString()).searchParams.get("keyword");this.input.value=e,e?this.doSearch(e.split(" ")):this.clear()}static updateQueryString(t,e=!1){let n=new URL(window.location.toString());t===""?n.searchParams.delete("keyword"):n.searchParams.set("keyword",t),e?window.history.replaceState("","",n.toString()):window.history.pushState("","",n.toString())}static render(t){let e=encodeURIComponent(t.matchKeywords||""),n=encodeURIComponent(JSON.stringify(t.matchPositions||[])),s=`${t.permalink}?keyword=${e}&matchPositions=${n}`;return createElement("article",null,createElement("a",{href:s,"data-pjax":!0}," ",createElement("div",{class:"article-details"},createElement("h2",{class:"article-title",dangerouslySetInnerHTML:{__html:t.title}}),createElement("section",{class:"article-preview",dangerouslySetInnerHTML:{__html:t.preview}})),t.image&&createElement("div",{class:"article-image"},createElement("img",{src:t.image,loading:"lazy"}))))}};function T(){let o=document.querySelector(".search-form");o&&setTimeout(function(){let t=o.querySelector("input"),e=document.querySelector(".search-result--list"),n=document.querySelector(".search-result--title");t&&e&&n&&window.searchResultTitleTemplate&&new m({form:o,input:t,list:e,resultTitle:n,resultTitleTemplate:window.searchResultTitleTemplate})},0)}var y=m;})();
